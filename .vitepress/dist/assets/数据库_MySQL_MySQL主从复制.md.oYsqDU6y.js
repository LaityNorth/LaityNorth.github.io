import{_ as s,c as i,o as a,a1 as n}from"./chunks/framework.DFHaK-wS.js";const l="/assets/Snipaste_2024-06-30_18-19-23.EHTY4IKb.png",p="/assets/Snipaste_2024-06-30_18-20-06.UWJo9EFN.png",e="/assets/Snipaste_2024-06-30_18-20-32.JFQwKX20.png",t="/assets/Snipaste_2024-06-30_18-21-15.DfY5U4-f.png",h="/assets/Snipaste_2024-06-30_18-26-56.Xr_FtjHj.png",r="/assets/Snipaste_2024-06-30_18-28-25.DTGNNYqZ.png",k="/assets/Snipaste_2024-06-30_18-29-13.-RGyXoAP.png",_=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"数据库/MySQL/MySQL主从复制.md","filePath":"数据库/MySQL/MySQL主从复制.md"}'),d={name:"数据库/MySQL/MySQL主从复制.md"},E=n('<h2 id="如何提升数据库并发能力" tabindex="-1">如何提升数据库并发能力 <a class="header-anchor" href="#如何提升数据库并发能力" aria-label="Permalink to &quot;如何提升数据库并发能力&quot;">​</a></h2><p><img src="'+l+'" alt="Snipaste_2024-06-30_18-19-23.png"></p><p>一般应用对数据库而言都是<span style="color:#0080c0;">“ 读多写少 ”</span>，也就说对数据库读取数据的压力比较大，有一个思路就 是采用数据库集群的方案，做 <span style="color:#0080c0;">主从架构 、进行 读写分离</span>，这样同样可以提升数据库的并发处理能力。但 并不是所有的应用都需要对数据库进行主从架构的设置，毕竟设置架构本身是有成本的。</p><p>如果我们的目的在于提升数据库高并发访问的效率，那么首先考虑的是如何 <span style="color:#0080c0;">优化SQL和索引 </span>，这种方式 简单有效；其次才是采用 <span style="color:#0080c0;">缓存的策略</span> ，比如使用 Redis将热点数据保存在内存数据库中，提升读取的效 率；最后才是对数据库采用 <span style="color:#0080c0;">主从架构 </span>，进行读写分离。</p><h2 id="什么是主从复制" tabindex="-1">什么是主从复制？ <a class="header-anchor" href="#什么是主从复制" aria-label="Permalink to &quot;什么是主从复制？&quot;">​</a></h2><p>主从复制是指将主数据库的DDL和DML操作通过二进制日志传到从数据库上，然后在从数据库上对这些日志进行重新执行，从而使从数据库和主数据库的数据保持一致。</p><h2 id="主从复制的作用" tabindex="-1">主从复制的作用 <a class="header-anchor" href="#主从复制的作用" aria-label="Permalink to &quot;主从复制的作用&quot;">​</a></h2><p>主从同步设计不仅可以提高数据库的吞吐量，还有以下 3 个方面的作用。</p><ul><li><p>读写分离</p><p><img src="'+p+'" alt="Snipaste_2024-06-30_18-20-06.png"></p></li><li><p>数据备份</p></li><li><p>具有高可用性</p></li></ul><h2 id="原理剖析" tabindex="-1">原理剖析 <a class="header-anchor" href="#原理剖析" aria-label="Permalink to &quot;原理剖析&quot;">​</a></h2><p>实际上主从同步的原理就是基于 binlog 进行数据同步的。在主从复制过程中，会基于 <span style="color:#0080c0;">3 个线程</span> 来操 作，一个主库线程，两个从库线程。</p><p>三个线程分别是：<span style="color:#0080c0;">master（binlog dump thread）、slave（I/O thread 、SQL thread）</span>。</p><p><img src="'+e+'" alt="Snipaste_2024-06-30_18-20-32.png"></p><p><span style="color:#0080c0;">二进制日志转储线程</span> （Binlog dump thread）是一个主库线程。当从库线程连接的时候， 主库可以将二进 制日志发送给从库，当主库读取事件（Event）的时候，会在 Binlog 上 加锁 ，读取完成之后，再将锁释 放掉。</p><p><span style="color:#0080c0;">从库 I/O 线程</span> 会连接到主库，向主库发送请求更新 Binlog。这时从库的 I/O 线程就可以读取到主库的 二进制日志转储线程发送的 Binlog 更新部分，并且拷贝到本地的中继日志 （Relay log）。</p><p><span style="color:#0080c0;">从库 SQL 线程</span> 会读取从库中的中继日志，并且执行日志中的事件，将从库中的数据与主库保持同步。</p><p><img src="'+t+`" alt="Snipaste_2024-06-30_18-21-15.png"></p><ol><li><p><span style="color:#0080c0;">Master </span>将写操作记录到二进制日志（ <span style="color:#0080c0;">binlog </span>）。</p></li><li><p><span style="color:#0080c0;">Slave</span> 将 Master 的binary log events拷贝到它的中继日志（ <span style="color:#0080c0;">relay log</span> ）。</p></li><li><p><span style="color:#0080c0;">Slave</span> 重做中继日志中的事件，将改变应用到自己的数据库中。 MySQL复制是异步的且串行化 的，而且重启后从 接入点 开始复制。</p></li></ol><blockquote><p>复制的最大问题：<span style="color:#0080c0;">延时</span></p></blockquote><h2 id="复制的基本原则" tabindex="-1">复制的基本原则 <a class="header-anchor" href="#复制的基本原则" aria-label="Permalink to &quot;复制的基本原则&quot;">​</a></h2><ul><li><p>每个 <span style="color:#0080c0;">Slave </span>只有一个 <span style="color:#0080c0;">Master </span></p></li><li><p>每个<span style="color:#0080c0;"> Slave </span>只能有一个唯一的服务器ID</p></li><li><p>每个 <span style="color:#0080c0;">Master</span> 可以有多个 <span style="color:#0080c0;">Slave</span></p></li></ul><h2 id="准备工作" tabindex="-1">准备工作 <a class="header-anchor" href="#准备工作" aria-label="Permalink to &quot;准备工作&quot;">​</a></h2><ol><li>准备 2台 CentOS 虚拟机</li><li>每台虚拟机上需要安装好MySQL (可以是MySQL8.0 ) 说明：前面我们讲过如何克隆一台CentOS。大家可以在一台CentOS上安装好MySQL，进而通过克隆的方式复制出1台包含MySQL的虚拟机。</li></ol><div class="tip custom-block github-alert"><p class="custom-block-title">注意</p><p>克隆的方式需要修改新克隆出来主机的： <span style="color:#0080c0;"> ① MAC地址 ② hostname ③ IP 地址 ④ UUID </span>。</p><p>此外，克隆的方式生成的虚拟机（包含MySQL Server），则克隆的虚拟机MySQL Server的UUID相同，必 须修&gt;改，否则在有些场景会报错。</p><p>比如： show slave status\\G ，报如下的错误： 修改MySQL Server 的UUID方式：</p></div><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Last_IO_Error: Fatal error: The slave I</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">O thread stops because </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">master</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> slave have</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">equal MySQL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UUIDs; these UUIDs must be different </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> replication </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">to</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> work.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>修改MySQL Server 的UUID方式：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改MySQL Server的UUID</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/mysql/auto.cnf</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重启MySQL服务配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mysqld</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="主机配置文件" tabindex="-1">主机配置文件 <a class="header-anchor" href="#主机配置文件" aria-label="Permalink to &quot;主机配置文件&quot;">​</a></h2><p>建议mysql版本一致且后台以服务运行，主从所有配置项都配置在 [mysqld] 节点下，且都是小写字母。 具体参数配置如下：</p><ul><li><p>必选</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[必须]主服务器唯一ID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[必须]启用二进制日志,指名路径。比如：自己本地的路径</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/log/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysqlbin</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">log-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">atguigu</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bin</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>可选</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[可选] </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">（默认）表示读写（主机），1表示只读（从机）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">read-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">only</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#设置日志文件保留的时长，单位是秒</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">binlog_expire_logs_seconds</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#控制单个二进制日志大小。此参数的最大和默认值是1GB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">max_binlog_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">200M</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[可选]设置不要复制的数据库</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">binlog</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-ignore-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">test</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[可选]设置需要复制的数据库,默认全部记录。比如：binlog</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">do</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">atguigu_master_slave</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">binlog</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">do</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">需要复制的主数据库名字</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[可选]设置binlog格式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">binlog_format</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=STATEMENT</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li></ul><h2 id="从机配置文件" tabindex="-1">从机配置文件 <a class="header-anchor" href="#从机配置文件" aria-label="Permalink to &quot;从机配置文件&quot;">​</a></h2><p>要求主从所有配置项都配置在 <span style="color:#0080c0;">my.cnf </span>的 <span style="color:#0080c0;">[mysqld] </span>栏位下，且都是小写字母。</p><ul><li><p>必选</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[必须]从服务器唯一ID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>可选</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[可选]启用中继日志</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">relay</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-log=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">relay</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul><p>重启后台mysql服务，使配置生效。</p><div class="danger custom-block github-alert"><p class="custom-block-title">注意</p><p>主从机都关闭防火墙</p><ul><li><p>service iptables stop #CentOS 6</p></li><li><p>systemctl stop firewalld.service #CentOS 7</p></li></ul></div><h2 id="在主机上-建立账户并授权" tabindex="-1">在主机上：建立账户并授权 <a class="header-anchor" href="#在主机上-建立账户并授权" aria-label="Permalink to &quot;在主机上：建立账户并授权&quot;">​</a></h2><p>MySQL5.7授权方式：</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#在主机MySQL里执行授权主从复制的命令</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GRANT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> REPLICATION SLAVE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;slave1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;从机器数据库IP&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IDENTIFIED </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;abc123&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="danger custom-block github-alert"><p class="custom-block-title">注意：如果使用的是MySQL8，需要如下的方式建立账户，并授权slave</p><p></p></div><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># 创建用户</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> USER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">slave1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IDENTIFIED </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;123456&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># 给创建的用户授权</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GRANT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> REPLICATION SLAVE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;slave1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#此语句必须执行。否则见下面。</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;slave1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IDENTIFIED </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mysql_native_password </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;123456&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># 刷新权限</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flush privileges;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="danger custom-block github-alert"><p class="custom-block-title">注意</p><p>如果在MySQL8中如果没有执行ALTER USER &#39;slave1&#39;@&#39;%&#39; IDENTIFIED WITH mysql_native_password BY &#39;123456&#39;;命令，则在从机执行show slave status\\G时报错如下</p><p>Last_IO_Error: error connecting to master &#39;slave1@192.168.1.150:3306&#39; - retry-time: 60 retries: 1 message: Authentication plugin &#39;caching_sha2_password&#39; reported error: Authentication requires secure connection.</p></div><p>查询Master的状态，并记录下File和Position的值。</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">show </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">master</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="`+h+`" alt="Snipaste_2024-06-30_18-26-56.png"></p><p>记录下File和Position的值</p><div class="danger custom-block github-alert"><p class="custom-block-title">注意：执行完此步骤后不要再操作主服务器MySQL，防止主服务器状态值变化。</p><p></p></div><h2 id="在从机上-配置需要复制的主机" tabindex="-1">在从机上：配置需要复制的主机 <a class="header-anchor" href="#在从机上-配置需要复制的主机" aria-label="Permalink to &quot;在从机上：配置需要复制的主机&quot;">​</a></h2><ol><li><p>从机上复制主机的命令</p><div class="language-properties vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CHANGE MASTER TO</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MASTER_HOST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;主机的IP地址&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MASTER_USER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;主机用户名&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MASTER_PASSWORD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;主机用户名的密码&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MASTER_LOG_FILE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mysql-bin.具体数字&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MASTER_LOG_POS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=具体值</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="tip custom-block github-alert"><p class="custom-block-title">举例</p><p></p><p>CHANGE MASTER TO MASTER_HOST=&#39;192.168.1.150&#39;,MASTER_USER=&#39;slave1&#39;,MASTER_PASSWORD=&#39;123456&#39;,MASTER_LOG_F ILE=&#39;atguigu-bin.000007&#39;,MASTER_LOG_POS=154;</p></div></li><li><p>启动slave同步</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#启动slave同步</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">START</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SLAVE;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果报错：</p><p><img src="`+r+`" alt="Snipaste_2024-06-30_18-28-25.png"></p><p>可以执行如下操作，删除之前的relay_log信息。然后重新执行 CHANGE MASTER TO ...语句即可。</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#删除SLAVE数据库的relaylog日志文件，并重新启用新的relaylog文件</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">reset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> slave;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接着，查看同步状态：</p><p><img src="`+k+'" alt="Snipaste_2024-06-30_18-29-13.png"></p></li></ol>',48),c=[E];function o(g,y,b,u,m,v){return a(),i("div",null,c)}const A=s(d,[["render",o]]);export{_ as __pageData,A as default};
